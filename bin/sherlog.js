#!/usr/bin/env node
!function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(s,n,function(t){return e[t]}.bind(null,n));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=33)}([function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("lodash/map")},function(e,t){e.exports=require("commander")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("moment-timezone")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("lodash/assign")},function(e,t){e.exports=require("lodash/compact")},function(e,t){e.exports=require("lodash/debounce")},function(e,t){e.exports=require("lodash/get")},function(e,t){e.exports=require("lodash/isEmpty")},function(e,t){e.exports=require("lodash/size")},function(e,t){e.exports=require("portfinder")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("compression")},function(e){e.exports=JSON.parse('{"hostname":"","files":[{"metric":"","file":"","timezone":""}]}')},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("ajv")},function(e,t){e.exports=require("open")},function(e,t){e.exports=require("pako")},function(e,t){e.exports=require("stream")},function(e,t){e.exports=require("console-clear")},function(e,t,r){var s,n,i,o,a=function(e,t){if(!(e instanceof t))throw new Error("Bound instance method accessed before binding")};n=r(10),i=r(0),o=r(6),s=class e extends n.EventEmitter{readBlock(){var t,r;if(a(this,e),this.queue.length>=1&&(t=this.queue[0]).end>t.start)return(r=i.createReadStream(this.filename,{start:t.start,end:t.end-1,encoding:this.encoding})).on("error",e=>(this.logger&&this.logger.error("Tail error: "+e),this.emit("error",e))),r.on("end",()=>{if(this.emit("line","<<EOF>>"),this.queue.shift(),this.queue.length>0&&this.internalDispatcher.emit("next"),this.flushAtEOF&&this.buffer.length>0)return this.emit("line",this.buffer),this.buffer=""}),r.on("data",e=>{var t,r,s,n,i;if(null===this.separator)return this.emit("line",e);for(this.buffer+=e,n=this.buffer.split(this.separator),this.buffer=n.pop(),i=[],r=0,s=n.length;r<s;r++)t=n[r],i.push(this.emit("line",t));return i})}constructor(e,t={}){var r,s;if(super(e,t),this.readBlock=this.readBlock.bind(this),this.change=this.change.bind(this),this.filename=e,this.absPath=o.dirname(this.filename),({separator:this.separator=/[\r]{0,1}\n/,fsWatchOptions:this.fsWatchOptions={},follow:this.follow=!0,logger:this.logger,useWatchFile:this.useWatchFile=!1,flushAtEOF:this.flushAtEOF=!1,encoding:this.encoding="utf-8",fromBeginning:s=!1}=t),this.logger){this.logger.info("Tail starting..."),this.logger.info("filename: "+this.filename),this.logger.info("encoding: "+this.encoding);try{i.accessSync(this.filename,i.constants.F_OK)}catch(e){if("ENOENT"===(r=e).code)throw r}}this.buffer="",this.internalDispatcher=new n.EventEmitter,this.queue=[],this.isWatching=!1,this.internalDispatcher.on("next",()=>this.readBlock()),this.watch(s)}change(t){var r,s;a(this,e);try{s=i.statSync(t)}catch(e){return r=e,this.logger&&this.logger.error(`change event for ${t} failed: ${r}`),void this.emit("error",`change event for ${t} failed: ${r}`)}if(s.size<this.pos&&(this.pos=s.size),s.size>this.pos&&(this.queue.push({start:this.pos,end:s.size}),this.pos=s.size,1===this.queue.length))return this.internalDispatcher.emit("next")}watch(e){var t,r;if(!this.isWatching){this.logger&&(this.logger.info("filesystem.watch present? "+(void 0!==i.watch)),this.logger.info("useWatchFile: "+this.useWatchFile),this.logger.info("fromBeginning: "+e)),this.isWatching=!0;try{r=i.statSync(this.filename)}catch(e){return t=e,this.logger&&this.logger.error(`watch for ${this.filename} failed: ${t}`),void this.emit("error",`watch for ${this.filename} failed: ${t}`)}return this.pos=e?0:r.size,0===this.pos&&this.change(this.filename),!this.useWatchFile&&i.watch?(this.logger&&this.logger.info("watch strategy: watch"),this.watcher=i.watch(this.filename,this.fsWatchOptions,(e,t)=>this.watchEvent(e,t))):(this.logger&&this.logger.info("watch strategy: watchFile"),i.watchFile(this.filename,this.fsWatchOptions,(e,t)=>this.watchFileEvent(e,t)))}}rename(e){if(void 0===e||e!==this.filename)return this.unwatch(),this.follow?(this.filename=o.join(this.absPath,e),this.rewatchId=setTimeout(()=>this.watch(),1e3)):(this.logger&&this.logger.error(`'rename' event for ${this.filename}. File not available.`),this.emit("error",`'rename' event for ${this.filename}. File not available.`))}watchEvent(e,t){return"change"===e?this.change(this.filename):"rename"===e?this.rename(t):void 0}watchFileEvent(e,t){if(e.size>t.size&&(this.pos=e.size,this.queue.push({start:t.size,end:e.size}),1===this.queue.length))return this.internalDispatcher.emit("next")}unwatch(){if(this.watcher?this.watcher.close():i.unwatchFile(this.filename),this.rewatchId&&(clearTimeout(this.rewatchId),this.rewatchId=void 0),this.isWatching=!1,this.queue=[],this.logger)return this.logger.info("Unwatch ",this.filename)}},t.Tail=s},function(e,t){e.exports=require("lodash/assignIn")},function(e,t){e.exports=require("lodash/groupBy")},function(e,t){e.exports=require("lodash/take")},function(e,t){e.exports=require("string.prototype.matchall")},function(e,t,r){"use strict";r.r(t);var s=r(0),n=r.n(s),i=r(6),o=r.n(i),a=r(11),c=r.n(a),h=r(12),l=r.n(h),u=r(13),m=r.n(u),f=r(14),p=r.n(f),g=r(15),d=r.n(g),y=r(2),b=r.n(y),x=r(16),w=r.n(x),v=r(17),S=r.n(v),q=r(7),F=r.n(q),O=r(18),M=r.n(O),Y=r(19),z=r.n(Y),D=r(20),E=r.n(D),T=r(21),J=r(8),k=r.n(J),N=r(9),$=r.n(N),j=r(22),P=r.n(j),W=r(4),H=r.n(W),A=r(3),B=r.n(A),_=r(23),Z=r.n(_),I=r(5),R=r.n(I),U=r(24),K=r.n(U),L=r(1),C=r.n(L),V=r(25),X=r.n(V),G=r(26),Q=r(27),ee=r.n(Q),te=r(28),re=r(29),se=r.n(re),ne=r(30),ie=r.n(ne),oe=r(31),ae=r.n(oe),ce=r(32),he=r.n(ce);class le{constructor(e){const{dateFormat:t,hostname:r,payload:s,metric:n,regex:i,eventType:o,timezone:a}=e;this.dateFormat=t,this.hostname=r,this.payload=s,this.metric=n,this.regex=i,this.eventType=o,this.timezone=a,this.buffer=[]}tag(e,t){return{metric:this.metric,tags:{hostname:this.hostname,type:this.eventType,platform:H.a.platform()},timestamp:Number(t),values:e}}format(e){const t=[];return e.forEach(e=>{const r=R.a.tz(e.datetime,this.dateFormat,this.timezone).clone().tz("UTC");t.push(se()(e,{datetime:r.format(),timestamp:Number(r.format("X"))}))}),b()(ie()(t,"timestamp"),(e,t)=>this.tag(e,t))}dispatch(e,t){const r=ae()(this.buffer,e).join("\n"),s=[...he()(r,this.regex)];s.length&&t(this.format(b()(s,"groups"))),this.buffer.splice(0,e)}onBuffer(e,t){if(this.buffer.length===this.payload||"<<EOF>>"===e){const e=this.buffer.length;this.dispatch(e,t)}this.buffer.push(e)}}class ue extends le{constructor(e){super({...e,dateFormat:"DD/MMM/YYYY:HH:mm:ss ZZ",regex:/^(?<client>\S+) \S+ .*\[(?<datetime>\d{2}\/(Jan(uary)?|Feb(ruary)?|Mar(ch)?|Apr(il)?|May|Jun(e)?|Jul(y)?|Aug(ust)?|Sep(tember)?|Oct(ober)?|Nov(ember)?|Dec(ember)?)\/\d{4}:\d{2}:\d{2}:\d{2} [+|-]\d{4})] (?<message>.*)/gm})}}class me extends le{constructor(e){super({...e,dateFormat:"ddd MMM DD HH:mm:ss.SSSSSS YYYY",regex:/\[(?<datetime>((Mon|Tue(s)?|Wed(nes)?|Thu(rs|r)?|Fri|Sat(ur)?|Sun)(day)?) (Jan(uary)?|Feb(ruary)?|Mar(ch)?|Apr(il)?|May|Jun(e)?|Jul(y)?|Aug(ust)?|Sep(tember)?|Oct(ober)?|Nov(ember)?|Dec(ember)?) \d{2} \d{2}:\d{2}:\d{2}\.\d{6} \d{4})] (?<message>.*)/gm})}}class fe extends le{constructor(e){super({...e,dateFormat:"YYYY-MM-DDTHH:mm:ss.SSSSSS[Z]",regex:/^(?<datetime>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{6}Z) (?<message>.*)/gm})}}class pe extends le{constructor(e){super({...e,dateFormat:"DD/MMM/YYYY:HH:mm:ss ZZ",regex:/^(?<client>\S+) \S+ .*\[(?<datetime>\d{2}\/(Jan(uary)?|Feb(ruary)?|Mar(ch)?|Apr(il)?|May|Jun(e)?|Jul(y)?|Aug(ust)?|Sep(tember)?|Oct(ober)?|Nov(ember)?|Dec(ember)?)\/\d{4}:\d{2}:\d{2}:\d{2} [+|-]\d{4})] (?<message>.*)/gm})}}class ge extends le{constructor(e){super({...e,dateFormat:"YYYY/MM/DD HH:mm:ss",regex:/^(?<datetime>\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)] (?<pid>\d+).(?<tid>\d+): (?<message>.*)/gm})}}var de={apache2:class{constructor(e){const{eventType:t}=e;return"http"===t?new ue(e):new me(e)}},monolog:class extends le{constructor(e){super({...e,dateFormat:"YYYY-MM-DD HH:mm:ss",regex:/^\[(?<datetime>.*)] (?<channel>.+?)\.(?<severity>[A-Z]+): (?<message>(?:[^\n][ \n]?)+)$/gm})}},mysql:class{constructor(e){const{eventType:t}=e;if("error"===t)return new fe(e)}},nginx:class{constructor(e){const{eventType:t}=e;return"http"===t?new pe(e):new ge(e)}},phpfpm:class extends le{constructor(e){super({...e,dateFormat:"DD-MMM-YYYY HH:mm:ss",regex:/\[(?<datetime>[^\]]+)].* (?<log_level>[A-Z]+:) (?<message>.*)/gm})}},redis:class extends le{constructor(e){super({...e,dateFormat:"DD MMM YYYY HH:mm:ss.SSS",regex:/^(?<pid>\d+:[A-Z]) (?<datetime>\d{2} (Jan(uary)?|Feb(ruary)?|Mar(ch)?|Apr(il)?|May|Jun(e)?|Jul(y)?|Aug(ust)?|Sep(tember)?|Oct(ober)?|Nov(ember)?|Dec(ember)?) \d{4} \d{2}:\d{2}:\d{2}\.\d{3}) (?<message>.*)/gm})}}};const ye=r(10);class be extends ye{constructor(e){super();const{hostname:t,files:r,chunks:s}=e;this.watcher=[],this.buffer=[];const n=Number(s)||1;this.config=r.forEach(e=>{const{metric:r,file:s,eventType:i,timezone:o,dateFormat:a,regex:c,fromBeginning:h}=e;if(!Object.keys(de).includes(r))return;const l=new de[r]({hostname:t,payload:n,metric:r,eventType:i,timezone:o,dateFormat:a,regex:c}),u=new te.Tail(s,{flushAtEOF:!0,fromBeginning:h});u.on("line",e=>{l.onBuffer(e,this.read.bind(this))}),u.on("error",e=>{this.emit("error",e)}),this.watcher.push(u)})}read(e){this.emit("buffer",e)}unwatch(){return new Promise((e,t)=>{try{this.watcher.forEach((e,t)=>{e.unwatch(),this.watcher.splice(t,1)}),e()}catch(e){t(e)}})}}const xe=o.a.normalize(process.execPath+"/../../lib/node_modules/@sherlog/cli"),we=JSON.parse(n.a.readFileSync(xe+"/package.json","utf8")),ve=new G.Readable({highWaterMark:1e5,objectMode:!0,encoding:"utf8"});ve._read=()=>{};const Se=e=>{process.on("warning",e=>{console.warn(e.stack),process.exit(1)});const t=k()(),r=P.a.createServer(t);t.use(z()({contentSecurityPolicy:!1})),t.use(M()()),t.use(E()()),t.use(F.a.json()),t.use(F.a.urlencoded({extended:!1}));const s=xe+"/public";n.a.existsSync(s)||(console.log("Unable to locate your global node_modules path"),process.exit(1)),t.use(k.a.static(s)),t.get("/ready",(e,t)=>{t.send("UP")}),t.use((e,t,r,s)=>{console.error(e.stack),s(e)}),S.a.getPortPromise().then(t=>{const s=e.port||t;r.listen(s,async()=>{const t=new $.a.Server({server:r}),n=e.backpressure?Number(e.backpressure):1e3,i=void 0===e.compression||Boolean(e.compression);ee()(!0);const o="http://localhost:"+s;console.log("Sherlog listening on:"),console.log("\n"),console.log("   - Dashboard:   "+C.a.green(o)),console.log("   - Websocket:   "+C.a.green("ws://localhost:"+s));const a=new be(e);a.on("buffer",e=>{ve.push(((e,t)=>t?X.a.deflate(JSON.stringify(e),{to:"string"}):JSON.stringify(e))(e,i))});const c=m()(()=>{if(w()(t.clients)){const e=ve.read();e&&t.clients.forEach(t=>{t.readyState===$.a.OPEN&&t.send(e)}),ve.pause(),c()}},n,{maxWait:2e3});ve.on("readable",c),a.on("error",e=>{console.error("ERROR: ",e)}),t.on("connection",async()=>{ve.emit("readable")}),setTimeout(async()=>{e.browser&&await K()(o)},500)})})},qe=n.a.existsSync(process.cwd()+"/.sherlog"),Fe=JSON.stringify(c()(T,{hostname:H.a.hostname()}),null,2),Oe=e=>{e.config&&!n.a.existsSync(e.config)&&(console.log("invalid config file path "+C.a.yellow(e.config)),process.exit(1)),qe||e.config||(console.log(C.a.yellow(".sherlog")+" not found. run the init command to initialize the current working directory"),process.exit(1));const t=n.a.readFileSync(e.config||".sherlog","utf8");(e=>{try{return JSON.parse(e),!0}catch(e){return!1}})(t)||(console.log("your config file has an invalid JSON syntax"),process.exit(1));const r=(e=>{const t=new Z.a({allErrors:!0}),r={type:"object",properties:{hostname:{type:"string",minimum:1},backpressure:{type:"number",minimum:0},chunks:{type:"number",minimum:1},env:{type:"string",minLength:1},compression:{type:"boolean",enum:[!0,!1]},files:{type:"array",uniqueItems:!0,minItems:1,maxItems:50,items:{type:"object",properties:{metric:{type:"string",enum:["apache2","nginx","phpfpm","monolog","mysql","redis"]},eventType:{type:"string",enum:["http","error"]},fromBeginning:{type:"boolean",enum:[!0,!1]},file:{type:"string",minLength:1},timezone:{type:"string",enum:R.a.tz.names()}},required:["metric","file","timezone"],if:{properties:{metric:{enum:["apache2","nginx","mysql"]}}},then:{required:["eventType"]}}}},required:["hostname","files"]},s=t.compile(r);return s(e)?[]:s.errors})(JSON.parse(t));d()(r)||(console.log((e=>l()(b()(e,e=>{if("if"!==e.keyword)return`${C.a.red("->")} ${e.dataPath} ${e.message} ${p()(e,"params.allowedValues","")}`})))(r).join(H.a.EOL)),process.exit(1))};B.a.command("init").option("-f, --force","force to overwrite .sherlog").description("initializes the project").action(e=>{!qe||qe&&e.force?(console.log("creating "+C.a.green(".sherlog")),n.a.writeFileSync(".sherlog",Fe),process.exit(0)):(console.log(`pass the --force option to overwrite your existing ${C.a.green(".sherlog")} config file`),process.exit(1))}),B.a.command("test").description("validate your config schema").option("-c, --config <path>","path to config file").action(e=>{Oe(e),console.log(`your ${C.a.green(e.config||".sherlog")} schema is valid!`),process.exit(0)}),B.a.command("start").description("start the server").option("-c, --config <path>","path to config file").option("-p, --port <port-number>","port number").option("--browser","open browser window").action(e=>{Oe(e);const t=JSON.parse(n.a.readFileSync(e.config||".sherlog","utf8")),r=b()(t.files,e=>new Promise((t,r)=>{n.a.access(e.file,n.a.constants.F_OK|n.a.constants.R_OK,s=>{s&&r(s),t(e.file)})}));Promise.all(r).then(()=>{Se({browser:Boolean(e.browser),port:e.port,...t})}).catch(e=>{const t=-2===e.errno?"no such file":"permission denied";console.log(`${t} ${C.a.yellow(e.path)}`),process.exit(1)})}),B.a.version(we.version,"-v, --version","print version"),B.a.parse(process.argv)}]);